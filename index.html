<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á∏¶Êõ∏„Åç„Ç∞„É™„ÉÉ„Éâ„Ç®„Éá„Ç£„Çø</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }
        
        .editor-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 100vh;
        }
        
        /* Â∑¶ÂÅ¥: „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ */
        .control-panel {
            background: #252525;
            border-right: 1px solid #333;
            overflow-y: auto;
            padding: 20px;
        }
        
        .control-panel h1 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #4a9eff;
        }
        
        .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        
        .section h2 {
            font-size: 14px;
            margin-bottom: 15px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            font-size: 13px;
            margin-bottom: 5px;
            color: #aaa;
        }
        
        .control-group input[type="text"],
        .control-group input[type="number"],
        .control-group input[type="color"],
        .control-group select,
        .control-group textarea {
            width: 100%;
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
        }
        
        .control-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .control-group input[type="range"] {
            width: 100%;
        }
        
        .btn {
            padding: 10px 15px;
            background: #4a9eff;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #3a8eef;
        }
        
        .btn-secondary {
            background: #555;
        }
        
        .btn-secondary:hover {
            background: #666;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        /* Âè≥ÂÅ¥: „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢ */
        .preview-area {
            background: #f5f5f5;
            overflow-y: auto;
            padding: 40px;
        }
        
        .preview-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* „Ç∞„É™„ÉÉ„Éâ„Ç¢„Ç§„ÉÜ„É†„ÅÆ„Ç≥„É≥„Éà„É≠„Éº„É´ */
        .grid-item-control {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .grid-item-control h3 {
            font-size: 14px;
            margin-bottom: 12px;
            color: #4a9eff;
        }
        
        .row-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .row-controls .btn {
            flex: 1;
            margin-top: 0;
            padding: 6px 10px;
            font-size: 12px;
        }
        
        .color-input-group {
            display: grid;
            grid-template-columns: 50px 1fr;
            gap: 8px;
            align-items: center;
        }
        
        input[type="color"] {
            height: 35px;
            cursor: pointer;
        }
        
        .range-value {
            display: inline-block;
            margin-left: 10px;
            color: #4a9eff;
            font-weight: 600;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        /* „Éó„É¨„Éì„É•„Éº„ÅÆ„Çπ„Çø„Ç§„É´ */
        .grid-row {
            display: grid;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .grid-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .grid-link {
            text-decoration: none;
            color: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .grid-link:hover {
            text-decoration: underline;
        }
        
        

        .grid-image {
            max-width: 100%;
            max-height: 100%;
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            position: relative;
            z-index: 2;
        }

        .grid-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-both {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        .overlay-wrap {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: stretch;
            justify-content: stretch;
        }

        .overlay-text {
            position: absolute;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(255,255,255,0.4);
        }
.vertical-text {
            writing-mode: vertical-rl;
            font-size: 24px;
            font-weight: 500;
            color: #333;
            letter-spacing: 0.1em;
            position: relative;
            z-index: 2;
        }
        
        .horizontal-text {
            writing-mode: horizontal-tb;
            font-size: 24px;
            font-weight: 500;
            color: #333;
            position: relative;
            z-index: 2;
        }
        
        .mincho {
            font-family: "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", "MS Mincho", serif;
        }
        
        .gothic {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic', sans-serif;
        }
        
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::before,
        .ripple::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.6);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: ripple-animation 2.5s ease-out forwards;
            z-index: 1;
        }
        
        .ripple::after {
            animation-delay: 0.5s;
        }
        
        @keyframes ripple-animation {
            0% {
                width: 40px;
                height: 40px;
                opacity: 0.8;
            }
            100% {
                width: 1500px;
                height: 1500px;
                opacity: 0;
            }
        }
        
        /* „Ç®„ÇØ„Çπ„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #252525;
            padding: 30px;
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-content h2 {
            margin-bottom: 20px;
            color: #4a9eff;
        }
        
        .modal-content textarea {
            width: 100%;
            height: 400px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
            font-family: monospace;
            font-size: 12px;
            padding: 15px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <!-- Â∑¶ÂÅ¥: „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ -->
        <div class="control-panel">
            <h1>üìù Á∏¶Êõ∏„Åç„Ç∞„É™„ÉÉ„Éâ„Ç®„Éá„Ç£„Çø</h1>
            
            <!-- „Ç∞„É≠„Éº„Éê„É´Ë®≠ÂÆö -->
            <div class="section">
                <h2>„Ç∞„É≠„Éº„Éê„É´Ë®≠ÂÆö</h2>
                <div class="control-group">
                    <label>ËÉåÊôØËâ≤</label>
                    <div class="color-input-group">
                        <input type="color" id="bg-color" value="#f5f5f5">
                        <input type="text" id="bg-color-text" value="#f5f5f5">
                    </div>
                </div>
                <div class="control-group">
                    <label>ÊúÄÂ§ßÂπÖ (px)</label>
                    <input type="number" id="max-width" value="1200" min="600" max="2000">
                </div>
            </div>
            
            <!-- „Ç∞„É™„ÉÉ„ÉâË°å„ÅÆÁÆ°ÁêÜ -->
            <div class="section">
                <h2>„Ç∞„É™„ÉÉ„ÉâË°å</h2>
                <div id="rows-container"></div>
                <button class="btn" onclick="addRow()">+ Êñ∞„Åó„ÅÑË°å„ÇíËøΩÂä†</button>
            </div>
            
            <!-- „Ç®„ÇØ„Çπ„Éù„Éº„Éà -->
            <div class="section">
                <h2>„Ç®„ÇØ„Çπ„Éù„Éº„Éà</h2>
                <button class="btn" onclick="exportHTML()">HTML„ÇíÂá∫Âäõ</button>
                <button class="btn btn-secondary" onclick="loadTemplate()">„ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠Ëæº</button>
            </div>
        </div>
        
        <!-- Âè≥ÂÅ¥: „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢ -->
        <div class="preview-area">
            <div class="preview-container" id="preview"></div>
        </div>
    </div>
    
    <!-- „Ç®„ÇØ„Çπ„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="export-modal">
        <div class="modal-content">
            <h2>HTMLÂá∫Âäõ</h2>
            <textarea id="export-code" readonly></textarea>
            <div class="modal-actions">
                <button class="btn" onclick="copyHTML()">„Ç≥„Éî„Éº</button>
                <button class="btn" onclick="downloadHTML()">„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                <button class="btn btn-secondary" onclick="closeModal()">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <script>
        // „Éá„Éº„ÇøÊßãÈÄ†
        let gridData = {
            bgColor: '#f5f5f5',
            maxWidth: 1200,
            rows: [
                {
                    id: 1,
                    columns: 1,
                    items: [
                        {
                            type: 'text',
                            imageUrl: '',
                            textPosition: 'center',
                            overlay: false,
                            text: 'Â§ß„Åç„Å™„ÉÜ„Ç≠„Çπ„Éà',
                            aspectRatio: '2/1',
                            hasRipple: true,
                            color: '#333',
                            fontSize: 24,
                            fontFamily: 'gothic',
                            isHorizontal: false,
                            borderWidth: 0,
                            borderColor: '#000000',
                            link: '',
                            newTab: true
                                                }
                    ]
                },
                {
                    id: 2,
                    columns: 2,
                    items: [
                        {
                            type: 'text',
                            imageUrl: '',
                            textPosition: 'center',
                            overlay: false,
                            text: 'Â∑¶ÂÅ¥„ÅÆ„ÉÜ„Ç≠„Çπ„Éà',
                            aspectRatio: '1/1',
                            hasRipple: true,
                            color: '#333',
                            fontSize: 24,
                            fontFamily: 'gothic',
                            isHorizontal: false,
                            borderWidth: 0,
                            borderColor: '#000000',
                            link: '',
                            newTab: true
                                                },
                        {
                            type: 'text',
                            imageUrl: '',
                            textPosition: 'center',
                            overlay: false,
                            text: 'Âè≥ÂÅ¥„ÅÆ„ÉÜ„Ç≠„Çπ„Éà',
                            aspectRatio: '1/1',
                            hasRipple: true,
                            color: '#333',
                            fontSize: 24,
                            fontFamily: 'gothic',
                            isHorizontal: false,
                            borderWidth: 0,
                            borderColor: '#000000',
                            link: '',
                            newTab: true
                                                }
                    ]
                }
            ]
        };
        
        let nextRowId = 3;
        
        // ÂàùÊúüÂåñ
        function init() {
            document.getElementById('bg-color').addEventListener('input', (e) => {
                gridData.bgColor = e.target.value;
                document.getElementById('bg-color-text').value = e.target.value;
                updatePreview();
            });
            
            document.getElementById('bg-color-text').addEventListener('input', (e) => {
                gridData.bgColor = e.target.value;
                document.getElementById('bg-color').value = e.target.value;
                updatePreview();
            });
            
            document.getElementById('max-width').addEventListener('input', (e) => {
                gridData.maxWidth = e.target.value;
                updatePreview();
            });
            
            renderControls();
            updatePreview();
        }
        
        // „Ç≥„É≥„Éà„É≠„Éº„É´„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderControls() {
            const container = document.getElementById('rows-container');
            container.innerHTML = '';
            
            gridData.rows.forEach((row, rowIndex) => {
                const rowControl = document.createElement('div');
                rowControl.className = 'grid-item-control';
                
                let itemsHTML = '';
                row.items.forEach((item, itemIndex) => {
                    itemsHTML += `
                        <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #444;">
                            <div class="control-group">
                                <label>„Ç¢„Ç§„ÉÜ„É† ${itemIndex + 1} - Ë°®Á§∫„Çø„Ç§„Éó</label>
                                <select onchange="updateItem(${rowIndex}, ${itemIndex}, 'type', this.value)">
                                    <option value="text" ${item.type === 'text' ? 'selected' : ''}>„ÉÜ„Ç≠„Çπ„Éà</option>
                                    <option value="image" ${item.type === 'image' ? 'selected' : ''}>ÁîªÂÉè</option>
                                    <option value="both" ${item.type === 'both' ? 'selected' : ''}>ÁîªÂÉèÔºã„ÉÜ„Ç≠„Çπ„Éà</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>ÁîªÂÉèURL</label>
                                <input type="text" placeholder="https://example.com/image.jpg" value="${item.imageUrl || ''}" onchange="updateItem(${rowIndex}, ${itemIndex}, 'imageUrl', this.value)">
                            </div>
                            <div class="control-group">
                                <label>„ÉÜ„Ç≠„Çπ„Éà‰ΩçÁΩÆÔºà‰∏≠Â§Æ / ‰∏ä / ‰∏ãÔºâ</label>
                                <select onchange="updateItem(${rowIndex}, ${itemIndex}, 'textPosition', this.value)">
                                    <option value="center" ${item.textPosition === 'center' ? 'selected' : ''}>‰∏≠Â§Æ</option>
                                    <option value="top" ${item.textPosition === 'top' ? 'selected' : ''}>‰∏ä</option>
                                    <option value="bottom" ${item.textPosition === 'bottom' ? 'selected' : ''}>‰∏ã</option>
                                </select>
                            </div>
                            <div class="control-group checkbox-group">
                                <input type="checkbox" id="overlay-${rowIndex}-${itemIndex}" ${item.overlay ? 'checked' : ''} onchange="updateItem(${rowIndex}, ${itemIndex}, 'overlay', this.checked)">
                                <label for="overlay-${rowIndex}-${itemIndex}">„Ç™„Éº„Éê„Éº„É¨„Ç§ÊñáÂ≠óÔºàÁîªÂÉè„ÅÆ‰∏ä„Å´Èáç„Å≠„ÇãÔºâ</label>
                            </div>

                            <div class="control-group">
                                <label>„Ç¢„Ç§„ÉÜ„É† ${itemIndex + 1} - „ÉÜ„Ç≠„Çπ„Éà</label>
                                <textarea onchange="updateItem(${rowIndex}, ${itemIndex}, 'text', this.value)">${item.text}</textarea>
                            </div>
                            <div class="control-group">
                                <label>„É™„É≥„ÇØURLÔºàÁ©∫„Å™„Çâ„É™„É≥„ÇØÁÑ°„ÅóÔºâ</label>
                                <input type="text" placeholder="https://example.com" value="${item.link || ''}" onchange="updateItem(${rowIndex}, ${itemIndex}, 'link', this.value)">
                            </div>
                            <div class="control-group checkbox-group">
                                <input type="checkbox" id="newtab-${rowIndex}-${itemIndex}" ${item.newTab !== false ? 'checked' : ''} onchange="updateItem(${rowIndex}, ${itemIndex}, 'newTab', this.checked)">
                                <label for="newtab-${rowIndex}-${itemIndex}">Êñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè</label>
                            </div>

                            <div class="control-group">
                                <label>„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî</label>
                                <select onchange="updateItem(${rowIndex}, ${itemIndex}, 'aspectRatio', this.value)">
                                    <option value="1/1" ${item.aspectRatio === '1/1' ? 'selected' : ''}>1:1 (Ê≠£ÊñπÂΩ¢)</option>
                                    <option value="2/1" ${item.aspectRatio === '2/1' ? 'selected' : ''}>2:1 (Ê®™Èï∑)</option>
                                    <option value="3/2" ${item.aspectRatio === '3/2' ? 'selected' : ''}>3:2</option>
                                    <option value="4/3" ${item.aspectRatio === '4/3' ? 'selected' : ''}>4:3</option>
                                    <option value="16/9" ${item.aspectRatio === '16/9' ? 'selected' : ''}>16:9</option>
                                    <option value="1/2" ${item.aspectRatio === '1/2' ? 'selected' : ''}>1:2 (Á∏¶Èï∑)</option>
                                    <option value="4/1" ${item.aspectRatio === '4/1' ? 'selected' : ''}>4:1 (Ë∂ÖÊ®™Èï∑)</option>
                                </select>
                            </div>
                            <div class="control-group checkbox-group">
                                <input type="checkbox" id="horizontal-${rowIndex}-${itemIndex}" ${item.isHorizontal ? 'checked' : ''} onchange="updateItem(${rowIndex}, ${itemIndex}, 'isHorizontal', this.checked)">
                                <label for="horizontal-${rowIndex}-${itemIndex}">Ê®™Êõ∏„Åç</label>
                            </div>
                            <div class="control-group">
                                <label>„Éï„Ç©„É≥„Éà</label>
                                <select onchange="updateItem(${rowIndex}, ${itemIndex}, 'fontFamily', this.value)">
                                    <option value="gothic" ${item.fontFamily === 'gothic' ? 'selected' : ''}>„Ç¥„Ç∑„ÉÉ„ÇØ‰Ωì</option>
                                    <option value="mincho" ${item.fontFamily === 'mincho' ? 'selected' : ''}>ÊòéÊúù‰Ωì</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>ÊñáÂ≠óËâ≤</label>
                                <div class="color-input-group">
                                    <input type="color" value="${item.color}" onchange="updateItem(${rowIndex}, ${itemIndex}, 'color', this.value)">
                                    <input type="text" value="${item.color}" onchange="updateItem(${rowIndex}, ${itemIndex}, 'color', this.value)">
                                </div>
                            </div>
                            <div class="control-group">
                                <label>„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫ <span class="range-value">${item.fontSize}px</span></label>
                                <input type="range" min="12" max="160" value="${item.fontSize}" oninput="updateItem(${rowIndex}, ${itemIndex}, 'fontSize', this.value); this.previousElementSibling.querySelector('.range-value').textContent = this.value + 'px'">
                            </div>
                            <div class="control-group">
                                <label>„Éú„Éº„ÉÄ„ÉºÂπÖ <span class="range-value">${item.borderWidth}px</span></label>
                                <input type="range" min="0" max="10" value="${item.borderWidth}" oninput="updateItem(${rowIndex}, ${itemIndex}, 'borderWidth', this.value); this.previousElementSibling.querySelector('.range-value').textContent = this.value + 'px'">
                            </div>
                            <div class="control-group">
                                <label>„Éú„Éº„ÉÄ„ÉºËâ≤</label>
                                <div class="color-input-group">
                                    <input type="color" value="${item.borderColor}" onchange="updateItem(${rowIndex}, ${itemIndex}, 'borderColor', this.value)">
                                    <input type="text" value="${item.borderColor}" onchange="updateItem(${rowIndex}, ${itemIndex}, 'borderColor', this.value)">
                                </div>
                            </div>
                            <div class="control-group checkbox-group">
                                <input type="checkbox" id="ripple-${rowIndex}-${itemIndex}" ${item.hasRipple ? 'checked' : ''} onchange="updateItem(${rowIndex}, ${itemIndex}, 'hasRipple', this.checked)">
                                <label for="ripple-${rowIndex}-${itemIndex}">Ê≥¢Á¥ã„Ç®„Éï„Çß„ÇØ„Éà</label>
                            </div>
                        </div>
                    `;
                });
                
                rowControl.innerHTML = `
                    <h3>Ë°å ${rowIndex + 1}</h3>
                    <div class="control-group">
                        <label>„Ç´„É©„É†Êï∞</label>
                        <input type="number" min="1" max="4" value="${row.columns}" onchange="updateColumns(${rowIndex}, this.value)">
                    </div>
                    ${itemsHTML}
                    <div class="row-controls">
                        <button class="btn btn-danger" onclick="deleteRow(${rowIndex})">Ë°å„ÇíÂâäÈô§</button>
                    </div>
                `;
                
                container.appendChild(rowControl);
            });
        }
        
        // „Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
        function updatePreview() {
            const preview = document.getElementById('preview');
            const previewArea = document.querySelector('.preview-area');
            previewArea.style.background = gridData.bgColor;
            preview.style.maxWidth = gridData.maxWidth + 'px';
            
            let html = '';
            gridData.rows.forEach(row => {
                html += `<div class="grid-row" style="grid-template-columns: repeat(${row.columns}, 1fr);">`;
                row.items.forEach(item => {
                    const rippleClass = item.hasRipple ? 'ripple' : '';
                    const fontClass = item.fontFamily === 'mincho' ? 'mincho' : 'gothic';
                    const textClass = item.isHorizontal ? 'horizontal-text' : 'vertical-text';

                    const justifyMap = { top: 'flex-start', center: 'center', bottom: 'flex-end' };
                    const justify = justifyMap[item.textPosition] || 'center';
                    const topMap = { top: '15%', center: '50%', bottom: '85%' };
                    const overlayTop = topMap[item.textPosition] || '50%';

                    const safeText = (item.text ?? '').toString();
                    const safeImg = (item.imageUrl ?? '').toString();
                    const overlayStyle = item.overlay ? (' top:' + overlayTop + ';') : '';

                    const textHtml = `<div class="${textClass} ${fontClass}${item.overlay ? ' overlay-text' : ''}" style="color: ${item.color}; font-size: ${item.fontSize}px;${overlayStyle}">${safeText}</div>`;

                    let content = '';
                    if (item.type === 'image') {
                        if (item.overlay) {
                            content = `<div class="overlay-wrap"><img class="grid-image" src="${safeImg}" alt="">${textHtml}</div>`;
                        } else {
                            content = `<div class="grid-content" style="justify-content:${justify};"><img class="grid-image" src="${safeImg}" alt=""></div>`;
                        }
                    } else if (item.type === 'both') {
                        if (item.overlay) {
                            content = `<div class="overlay-wrap"><img class="grid-image" src="${safeImg}" alt="">${textHtml}</div>`;
                        } else {
                            content = `<div class="grid-both" style="justify-content:${justify};">${textHtml}<img class="grid-image" src="${safeImg}" alt=""></div>`;
                        }
                    } else { // text
                        content = `<div class="grid-content" style="justify-content:${justify};">${textHtml}</div>`;
                    }

                    html += `
                        <div class="grid-item ${rippleClass}" style="aspect-ratio: ${item.aspectRatio}; border: ${item.borderWidth}px solid ${item.borderColor};">
                            ${item.link ? `<a class="grid-link" href="${item.link}" ${item.newTab !== false ? 'target="_blank" rel="noopener noreferrer"' : ''}>` : ``}
                                ${content}
                            ${item.link ? `</a>` : ``}
                        </div>
                    `;
                });
                html += '</div>';
            });
            
            preview.innerHTML = html;
        }
        
        // „Ç¢„Ç§„ÉÜ„É†„ÇíÊõ¥Êñ∞
        function updateItem(rowIndex, itemIndex, property, value) {
            gridData.rows[rowIndex].items[itemIndex][property] = value;
            updatePreview();
        }
        
        // „Ç´„É©„É†Êï∞„ÇíÊõ¥Êñ∞
        function updateColumns(rowIndex, columns) {
            const newColumns = parseInt(columns);
            const row = gridData.rows[rowIndex];
            const currentItems = row.items.length;
            
            if (newColumns > currentItems) {
                // „Ç¢„Ç§„ÉÜ„É†„ÇíËøΩÂä†
                for (let i = currentItems; i < newColumns; i++) {
                    row.items.push({
                        type: 'text',
                        imageUrl: '',
                        textPosition: 'center',
                        overlay: false,
                        text: `„ÉÜ„Ç≠„Çπ„Éà ${i + 1}`,
                        aspectRatio: '1/1',
                        hasRipple: true,
                        color: '#333',
                        fontSize: 24,
                        fontFamily: 'gothic',
                        isHorizontal: false,
                        borderWidth: 0,
                        borderColor: '#000000',
                        link: '',
                        newTab: true
                                        });
                }
            } else if (newColumns < currentItems) {
                // „Ç¢„Ç§„ÉÜ„É†„ÇíÂâäÈô§
                row.items = row.items.slice(0, newColumns);
            }
            
            row.columns = newColumns;
            renderControls();
            updatePreview();
        }
        
        // Ë°å„ÇíËøΩÂä†
        function addRow() {
            gridData.rows.push({
                id: nextRowId++,
                columns: 1,
                items: [
                    {
                        type: 'text',
                        imageUrl: '',
                        textPosition: 'center',
                        overlay: false,
                        text: 'Êñ∞„Åó„ÅÑ„ÉÜ„Ç≠„Çπ„Éà',
                        aspectRatio: '2/1',
                        hasRipple: true,
                        color: '#333',
                        fontSize: 24,
                        fontFamily: 'gothic',
                        isHorizontal: false,
                        borderWidth: 0,
                        borderColor: '#000000',
                        link: '',
                        newTab: true
                                        }
                ]
            });
            renderControls();
            updatePreview();
        }
        
        // Ë°å„ÇíÂâäÈô§
        function deleteRow(rowIndex) {
            if (confirm('„Åì„ÅÆË°å„ÇíÂâäÈô§„Åó„Åæ„Åô„Åã?')) {
                gridData.rows.splice(rowIndex, 1);
                renderControls();
                updatePreview();
            }
        }
        
        // HTML„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportHTML() {
            let html = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç∞„É™„ÉÉ„Éâ„É¨„Ç§„Ç¢„Ç¶„Éà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: ${gridData.bgColor};
        }
        
        .container {
            max-width: ${gridData.maxWidth}px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .grid-row {
            display: grid;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .grid-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .grid-link {
            text-decoration: none;
            color: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .grid-link:hover {
            text-decoration: underline;
        }

        .grid-image {
            max-width: 100%;
            max-height: 100%;
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            position: relative;
            z-index: 2;
        }

        .grid-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-both {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        .overlay-wrap {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: stretch;
            justify-content: stretch;
        }

        .overlay-text {
            position: absolute;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(255,255,255,0.4);
        }

        
        .vertical-text {
            writing-mode: vertical-rl;
            font-size: 24px;
            font-weight: 500;
            color: #333;
            letter-spacing: 0.1em;
            position: relative;
            z-index: 2;
        }
        
        .horizontal-text {
            writing-mode: horizontal-tb;
            font-size: 24px;
            font-weight: 500;
            color: #333;
            position: relative;
            z-index: 2;
        }
        
        .mincho {
            font-family: "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", "MS Mincho", serif;
        }
        
        .gothic {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic', sans-serif;
        }
        
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::before,
        .ripple::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.6);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: ripple-animation 2.5s ease-out forwards;
            z-index: 1;
        }
        
        .ripple::after {
            animation-delay: 0.5s;
        }
        
        @keyframes ripple-animation {
            0% {
                width: 40px;
                height: 40px;
                opacity: 0.8;
            }
            100% {
                width: 1500px;
                height: 1500px;
                opacity: 0;
            }
        }
        
        @media (max-width: 768px) {
            .grid-row {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
`;
            
            gridData.rows.forEach(row => {
                html += `        <div class="grid-row" style="grid-template-columns: repeat(${row.columns}, 1fr);">\n`;
                row.items.forEach(item => {
                    const rippleClass = item.hasRipple ? ' ripple' : '';
                    const fontClass = item.fontFamily === 'mincho' ? ' mincho' : ' gothic';
                    const textClass = item.isHorizontal ? ' horizontal-text' : ' vertical-text';

                    const justifyMap = { top: 'flex-start', center: 'center', bottom: 'flex-end' };
                    const justify = justifyMap[item.textPosition] || 'center';
                    const topMap = { top: '15%', center: '50%', bottom: '85%' };
                    const overlayTop = topMap[item.textPosition] || '50%';

                    const safeText = (item.text ?? '').toString();
                    const safeImg = (item.imageUrl ?? '').toString();
                    const overlayStyle = item.overlay ? (' top:' + overlayTop + ';') : '';

                    const textHtml = `<div class="${textClass}${fontClass}${item.overlay ? ' overlay-text' : ''}" style="color: ${item.color}; font-size: ${item.fontSize}px;${overlayStyle}">${safeText}</div>`;

                    let content = '';
                    if (item.type === 'image') {
                        if (item.overlay) {
                            content = `<div class="overlay-wrap"><img class="grid-image" src="${safeImg}" alt="">${textHtml}</div>`;
                        } else {
                            content = `<div class="grid-content" style="justify-content:${justify};"><img class="grid-image" src="${safeImg}" alt=""></div>`;
                        }
                    } else if (item.type === 'both') {
                        if (item.overlay) {
                            content = `<div class="overlay-wrap"><img class="grid-image" src="${safeImg}" alt="">${textHtml}</div>`;
                        } else {
                            content = `<div class="grid-both" style="justify-content:${justify};">${textHtml}<img class="grid-image" src="${safeImg}" alt=""></div>`;
                        }
                    } else {
                        content = `<div class="grid-content" style="justify-content:${justify};">${textHtml}</div>`;
                    }

                    html += `            <div class="grid-item${rippleClass}" style="aspect-ratio: ${item.aspectRatio}; border: ${item.borderWidth}px solid ${item.borderColor};">
`;
                    if (item.link) {
                        const safeHref = item.link;
                        const targetAttrs = (item.newTab !== false) ? ' target="_blank" rel="noopener noreferrer"' : '';
                        html += `                <a class="grid-link" href="${safeHref}"${targetAttrs}>
`;
                    }
                    html += `                ${content}
`;
                    if (item.link) {
                        html += `                </a>
`;
                    }
                    html += `            </div>
`;
});
                html += `        </div>\n`;
            });
            
            html += `    </div>
</body>
</html>`;
            
            document.getElementById('export-code').value = html;
            document.getElementById('export-modal').classList.add('active');
        }
        
        // HTML„Çí„Ç≥„Éî„Éº
        function copyHTML() {
            const textarea = document.getElementById('export-code');
            textarea.select();
            document.execCommand('copy');
            alert('HTML„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü!');
        }
        
        // HTML„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function downloadHTML() {
            const html = document.getElementById('export-code').value;
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'grid-layout.html';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeModal() {
            document.getElementById('export-modal').classList.remove('active');
        }
        
        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠Ëæº
        function loadTemplate() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.html';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        parseHTMLTemplate(event.target.result);
                    } catch (error) {
                        alert('HTML„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // HTML„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíËß£Êûê
        function parseHTMLTemplate(htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            
            // ËÉåÊôØËâ≤„ÇíÂèñÂæó
            const bgStyle = doc.body.style.background || '#f5f5f5';
            gridData.bgColor = bgStyle;
            document.getElementById('bg-color').value = bgStyle;
            document.getElementById('bg-color-text').value = bgStyle;
            
            // „Ç≥„É≥„ÉÜ„Éä„ÅÆÊúÄÂ§ßÂπÖ„ÇíÂèñÂæó
            const container = doc.querySelector('.container');
            if (container) {
                const maxWidth = parseInt(container.style.maxWidth) || 1200;
                gridData.maxWidth = maxWidth;
                document.getElementById('max-width').value = maxWidth;
            }
            
            // „Ç∞„É™„ÉÉ„ÉâË°å„ÇíËß£Êûê
            const rows = doc.querySelectorAll('.grid-row');
            gridData.rows = [];
            
            rows.forEach(row => {
                const items = row.querySelectorAll('.grid-item');
                const rowData = {
                    id: nextRowId++,
                    columns: items.length,
                    items: []
                };
                
                items.forEach(item => {
                    const textEl = item.querySelector('.vertical-text, .horizontal-text');
                    const linkEl = item.querySelector('a.grid-link, a');
                    const imgEl = item.querySelector('img.grid-image, img');
                    const overlayWrap = item.querySelector('.overlay-wrap');
                    const link = linkEl ? (linkEl.getAttribute('href') || '') : '';
                    const newTab = linkEl ? ((linkEl.getAttribute('target') === '_blank') || (linkEl.getAttribute('rel') || '').includes('noopener')) : true;
                    
                    const text = textEl ? textEl.textContent : '';
                    const aspectRatio = item.style.aspectRatio || '1/1';
                    const hasRipple = item.classList.contains('ripple');
                    const color = textEl ? textEl.style.color || '#333' : '#333';
                    const fontSize = textEl ? parseInt(textEl.style.fontSize) || 24 : 24;
                    const borderWidth = parseInt(item.style.borderWidth) || 0;
                    const borderColor = item.style.borderColor || '#000000';
                    const fontFamily = textEl && textEl.classList.contains('mincho') ? 'mincho' : 'gothic';
                    const isHorizontal = textEl && textEl.classList.contains('horizontal-text');

                    const imageUrl = imgEl ? (imgEl.getAttribute('src') || '') : '';
                    const overlay = !!overlayWrap || (textEl && textEl.classList.contains('overlay-text'));
                    let type = 'text';
                    if (imageUrl && text) type = 'both';
                    else if (imageUrl) type = 'image';
                    const textPosition = 'center';

                    
                    rowData.items.push({
                        type,
                        imageUrl,
                        textPosition,
                        overlay,
                        text,
                        aspectRatio,
                        hasRipple,
                        color,
                        fontSize,
                        fontFamily,
                        isHorizontal,
                        borderWidth,
                        borderColor,
                        link,
                        newTab
                    });
                });
                
                gridData.rows.push(rowData);
            });
            
            renderControls();
            updatePreview();
            alert('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü!');
        }
        
        // ÂàùÊúüÂåñÂÆüË°å
        init();
    </script>
</body>
</html>
